# ----------------------------------------------------------------------------
#
#     ***     AUTO GENERATED CODE    ***    Type: MMv1     ***
#
# ----------------------------------------------------------------------------
#
#     This file is automatically generated by Magic Modules and manual
#     changes will be clobbered when the file is regenerated.
#
# ----------------------------------------------------------------------------
- name: Main test block
  block:
    - name: Create test network
      google.cloud.gcp_compute_network:
        name: "{{ resource_name }}"
        state: present
        auto_create_subnetworks: true
        project: "{{ gcp_project }}"
        auth_kind: "{{ gcp_cred_kind }}"
        service_account_file: "{{ gcp_cred_file }}"
      register: _network

    - name: Test case
      block:
        - name: Create BigQuery Dataset
          google.cloud.gcp_bigquery_dataset:
            state: present
            dataset_reference:
              dataset_id: "{{ resource_name | regex_replace('-', '_') }}"
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

        - name: Create BigQuery Table
          google.cloud.gcp_bigquery_table:
            state: present
            name: "{{ resource_name }}"
            dataset: "{{ resource_name | regex_replace('-', '_') }}"
            table_reference:
              dataset_id: "{{ resource_name | regex_replace('-', '_') }}"
              table_id: "{{ resource_name }}"
              project_id: "{{ gcp_project }}"
            schema:
              fields:
                - name: entity_id
                  type: STRING
                  mode: REQUIRED
                - name: feature_timestamp
                  type: TIMESTAMP
                  mode: REQUIRED
                - name: entity_column
                  type: STRING
                  mode: NULLABLE
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

        - name: Create Feature Online Store
          google.cloud.gcp_vertexai_feature_online_store:
            state: present
            name: "{{ resource_name | regex_replace('-', '_') }}"
            bigtable:
              auto_scaling:
                min_node_count: 1
                max_node_count: 3
                cpu_utilization_target: 50
            region: us-central1
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

        - name: Create Feature Online Store Featureview
          google.cloud.gcp_vertexai_feature_online_store_featureview:
            state: present
            name: "{{ resource_name | regex_replace('-', '_') }}"
            feature_online_store: "{{ resource_name | regex_replace('-', '_') }}"
            sync_config:
              cron: "0 0 * * *"
            big_query_source:
              uri: "bq://{{ gcp_project }}.{{ resource_name | regex_replace('-', '_') }}.{{ resource_name }}"
              entity_id_columns:
                - entity_column
            region: us-central1
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

        - name: Delete Feature Online Store Featureview
          google.cloud.gcp_vertexai_feature_online_store_featureview:
            state: absent
            name: "{{ resource_name | regex_replace('-', '_') }}"
            feature_online_store: "{{ resource_name | regex_replace('-', '_') }}"
            sync_config:
              cron: "0 0 * * *"
            big_query_source:
              uri: "bq://{{ gcp_project }}.{{ resource_name | regex_replace('-', '_') }}.{{ resource_name }}"
              entity_id_columns:
                - entity_column
            region: us-central1
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

      always:
        - name: Delete Feature Online Store
          google.cloud.gcp_vertexai_feature_online_store:
            state: absent
            name: "{{ resource_name | regex_replace('-', '_') }}"
            bigtable:
              auto_scaling:
                min_node_count: 1
                max_node_count: 3
                cpu_utilization_target: 50
            force_destroy: true
            region: us-central1
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

        - name: Delete BigQuery Table
          google.cloud.gcp_bigquery_table:
            state: absent
            name: "{{ resource_name }}"
            dataset: "{{ resource_name | regex_replace('-', '_') }}"
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

        - name: Delete BigQuery Dataset
          google.cloud.gcp_bigquery_dataset:
            state: absent
            dataset_reference:
              dataset_id: "{{ resource_name | regex_replace('-', '_') }}"
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

  always:
    - name: Destroy test network
      google.cloud.gcp_compute_network:
        name: "{{ resource_name }}"
        state: absent
        project: "{{ gcp_project }}"
        auth_kind: "{{ gcp_cred_kind }}"
        service_account_file: "{{ gcp_cred_file }}"
