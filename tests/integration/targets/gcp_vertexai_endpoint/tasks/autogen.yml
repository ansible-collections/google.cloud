# ----------------------------------------------------------------------------
#
#     ***     AUTO GENERATED CODE    ***    Type: MMv1     ***
#
# ----------------------------------------------------------------------------
#
#     This file is automatically generated by Magic Modules and manual
#     changes will be clobbered when the file is regenerated.
#
# ----------------------------------------------------------------------------
- name: Main test block
  block:
    - name: Create test network
      google.cloud.gcp_compute_network:
        name: "{{ resource_name }}"
        state: present
        auto_create_subnetworks: true
        project: "{{ gcp_project }}"
        auth_kind: "{{ gcp_cred_kind }}"
        service_account_file: "{{ gcp_cred_file }}"
      register: _network

    - name: Test case
      block:
        - name: Create peering range
          google.cloud.gcp_compute_global_address:
            name: "{{ resource_name }}-peering"
            state: present
            address_type: INTERNAL
            prefix_length: 16
            purpose: VPC_PEERING
            network: "{{ _network }}"
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

        - name: Create temporary directory
          ansible.builtin.tempfile:
            state: directory
          register: _tempdir

        - name: Connect block
          block:
            - name: Connect peering range
              environment:
                CLOUDSDK_CONFIG: "{{ _tempdir.path }}"
                GOOGLE_APPLICATION_CREDENTIALS: "{{ gcp_cred_file }}"
              ansible.builtin.shell: |
                cd $CLOUDSDK_CONFIG
                gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
                gcloud services vpc-peerings connect \
                  --quiet \
                  --service=servicenetworking.googleapis.com \
                  --ranges="{{ resource_name }}-peering" \
                  --network="{{ _network.name }}" \
                  --project="{{ gcp_project }}"
              register: _cmd
              failed_when:
                - "'finished successfully' not in _cmd.stderr"
              changed_when: true
          always:
            - name: Delete temporary directory
              ansible.builtin.file:
                path: "{{ _tempdir.path }}"
                state: absent

        - name: Create Endpoint
          google.cloud.gcp_vertexai_endpoint:
            name: "{{ resource_name }}"
            state: present
            display_name: "{{ resource_name }}"
            network: "projects/{{ gcp_project_number }}/global/networks/{{ _network.name }}"
            region: us-central1
            location: us-central1
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"
          register: _myep

        - name: Run assertions
          ansible.builtin.assert:
            that:
              - _myep.changed == true

      always:
        - name: Delete Endpoint
          google.cloud.gcp_vertexai_endpoint:
            name: "{{ resource_name }}"
            state: absent
            display_name: "{{ resource_name }}"
            network: "projects/{{ gcp_project_number }}/global/networks/{{ _network.name }}"
            location: us-central1
            region: us-central1
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

        - name: Delete peering range
          google.cloud.gcp_compute_global_address:
            name: "{{ resource_name }}-peering"
            state: absent
            address_type: INTERNAL
            prefix_length: 16
            purpose: VPC_PEERING
            network: "{{ _network }}"
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

  always:
    - name: Destroy test network
      google.cloud.gcp_compute_network:
        name: "{{ resource_name }}"
        state: absent
        project: "{{ gcp_project }}"
        auth_kind: "{{ gcp_cred_kind }}"
        service_account_file: "{{ gcp_cred_file }}"
