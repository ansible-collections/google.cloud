# ----------------------------------------------------------------------------
#
#     ***     AUTO GENERATED CODE    ***    Type: MMv1     ***
#
# ----------------------------------------------------------------------------
#
#     This file is automatically generated by Magic Modules and manual
#     changes will be clobbered when the file is regenerated.
#
# ----------------------------------------------------------------------------
- name: Main test block
  block:
    - name: Create test network
      google.cloud.gcp_compute_network:
        name: "{{ resource_name }}"
        state: present
        auto_create_subnetworks: true
        project: "{{ gcp_project }}"
        auth_kind: "{{ gcp_cred_kind }}"
        service_account_file: "{{ gcp_cred_file }}"
      register: _network

    - name: Test case
      block:
        - name: Create storage bucket
          google.cloud.gcp_storage_bucket:
            name: "{{ resource_name }}"
            state: present
            location: us-central1
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

        - name: Create delta configs
          ansible.builtin.copy:
            dest: "/tmp/{{ resource_name }}-{{ item }}"
            mode: "0644"
            content: |
              {"id": "42", "embedding": [0.5, 1.0], "restricts": [{"namespace": "class", "allow": ["cat", "pet"]},{"namespace": "category", "allow": ["feline"]}]}
              {"id": "43", "embedding": [0.6, 1.0], "restricts": [{"namespace": "class", "allow": ["dog", "pet"]},{"namespace": "category", "allow": ["canine"]}]}
          loop:
            - v1
            - v2

        - name: Upload delta configs to bucket
          google.cloud.gcp_storage_object:
            action: upload
            bucket: "{{ resource_name }}"
            src: "/tmp/{{ resource_name }}-{{ item }}"
            dest: "contents-{{ item }}/data.json"
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"
          loop:
            - v1
            - v2

        - name: Create Index
          google.cloud.gcp_vertexai_index:
            state: present
            display_name: "{{ resource_name }}"
            region: us-central1
            metadata:
              contents_delta_uri: "gs://{{ resource_name }}/contents-v1"
              config:
                dimensions: 2
                approximate_neighbors_count: 150
                shard_size: SHARD_SIZE_SMALL
                distance_measure_type: DOT_PRODUCT_DISTANCE
                algorithm_config:
                  tree_ah_config:
                    leaf_node_embedding_count: 500
                    leaf_nodes_to_search_percent: 7
            index_update_method: BATCH_UPDATE
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"
          register: _myidx

        - name: Run assertions
          ansible.builtin.assert:
            that:
              - _myidx.changed == true

        - name: Attempt to update description and metadata.contentsDeltaUri Index
          google.cloud.gcp_vertexai_index:
            state: present
            display_name: "{{ resource_name }}"
            description: "Updated description"
            region: us-central1
            metadata:
              contents_delta_uri: "gs://{{ resource_name }}/contents-v2"
              config:
                dimensions: 2
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"
          register: _myidx
          ignore_errors: true

        - name: Previous task should have failed
          ansible.builtin.assert:
            that:
              - _myidx.failed == true

        - name: Update Index description only
          google.cloud.gcp_vertexai_index:
            state: present
            display_name: "{{ resource_name }}"
            description: "Updated description"
            metadata:
              config:
                dimensions: 2
            region: us-central1
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"
          register: _myidx

        - name: Run assertions
          ansible.builtin.assert:
            that:
              - _myidx.changed == true
              - _myidx.description == "Updated description"

        - name: Update Index metadata only
          google.cloud.gcp_vertexai_index:
            state: present
            display_name: "{{ resource_name }}"
            region: us-central1
            metadata:
              contents_delta_uri: "gs://{{ resource_name }}/contents-v2"
              config:
                dimensions: 2
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"
          register: _myidx

        - name: Run assertions
          ansible.builtin.assert:
            that:
              - _myidx.changed == true

        - name: Delete Index
          google.cloud.gcp_vertexai_index:
            state: absent
            display_name: "{{ resource_name }}"
            metadata:
              config:
                dimensions: 2
            region: us-central1
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

      always:
        - name: Delete delta configs
          ansible.builtin.file:
            path: "/tmp/{{ resource_name }}-{{ item }}"
            state: absent
          loop:
            - v1
            - v2

        - name: Empty bucket
          google.cloud.gcp_storage_object:
            action: delete
            bucket: "{{ resource_name }}"
            src: "contents-{{ item }}/data.json"
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"
          loop:
            - v1
            - v2

        - name: Destroy storage bucket
          google.cloud.gcp_storage_bucket:
            name: "{{ resource_name }}"
            state: absent
            location: us-central1
            project: "{{ gcp_project }}"
            auth_kind: "{{ gcp_cred_kind }}"
            service_account_file: "{{ gcp_cred_file }}"

  always:
    - name: Destroy test network
      google.cloud.gcp_compute_network:
        name: "{{ resource_name }}"
        state: absent
        project: "{{ gcp_project }}"
        auth_kind: "{{ gcp_cred_kind }}"
        service_account_file: "{{ gcp_cred_file }}"
